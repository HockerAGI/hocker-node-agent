import crypto from "node:crypto";
import { stableStringify } from "./stable-json.js";

export function signCommand(secret: string, input: { id: string; node_id: string; command: string; payload: any }) {
  const canonical = stableStringify({
    id: input.id,
    node_id: input.node_id,
    command: input.command,
    payload: input.payload ?? {}
  });
  return crypto.createHmac("sha256", secret).update(canonical).digest("base64");
}

export function verifySignature(secret: string, sig: string, input: { id: string; node_id: string; command: string; payload: any }) {
  const expected = signCommand(secret, input);
  const a = Buffer.from(String(sig || ""));
  const b = Buffer.from(String(expected || ""));
  if (a.length !== b.length) return false;
  return crypto.timingSafeEqual(a, b);
}